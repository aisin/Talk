block variables
    -var title = '创建主题'

extends ../common/layout

block prepend style
    link(href="/simditor/styles/simditor.css", rel="stylesheet")
    link(href="/essage/essage.css", rel="stylesheet")

block header
    include ../common/header
block append main
    #Wrap
        .container
            #Main
                .box
                    .crumbs
                        a(href="/") V2EX
                        span.chevron &nbsp;›&nbsp;
                        | 创作新主题
                    form#newThreadForm
                        .cell 主题标题
                            #titleLength.fr.fade 120
                        .cell.full
                            input#title(type="text", name="title", autofocus, placeholder="请输入主题标题，如果标题能够表达完整内容，则正文可以为空")
                        .cell 正文
                            #contentLength.fr.fade 2000
                        .cell.full
                            textarea#editor
                        .cell
                            button#submit.super.normal.button(type="button")
                                i.fa.fa-paper-plane
                                | &nbsp;发布主题

            include ../common/sidebar

block footer
    include ../common/footer

block append script
    script(type="text/javascript", src="/simditor/scripts/module.js")
    script(type="text/javascript", src="/simditor/scripts/hotkeys.js")
    script(type="text/javascript", src="/simditor/scripts/uploader.js")
    script(type="text/javascript", src="/simditor/scripts/simditor.js")
    script(type="text/javascript", src="/essage/essage.js")
    script(type="text/javascript").
        $(function(){
            //editor
            var editor = new Simditor({
                textarea: $('#editor'),
                placeholder: '文明上网，文明发言',
                defaultImage: 'images/image.png'
            });

            $('#submit').click(function(){
                var title = $('#title').val();
                var content = editor.getValue();
                if(!title){
                    Essage.show({
                        message: '主题标题不能为空',
                        status: 'error'
                    }, 2000);
                }else if(!content){
                    Essage.show({
                        message: '主题内容不能为空',
                        status: 'error'
                    }, 2000);
                }else if(content.length > 1000){
                    Essage.show({
                        message: '主题内容不能超过 1000 个字符',
                        status: 'error'
                    }, 2000);
                }else{
                    $('#content').val(content);
                    var formVal = $('#newThreadForm').serialize();
                    $.post('/thread/new', formVal, function (data) {
                        if (data.status == 1) {
                            Essage.show({
                                message: data.msg,
                                status: 'success',
                                redirect : '/'
                            }, 2000);
                        } else {
                            Essage.show({
                                message: data.msg,
                                status: 'error'
                            }, 2000);
                        }
                    }, 'json');
                }
            });
        });